// ================= [ì„¤ì • ì˜ì—­: firebase ì´ˆê¸°í™” ì‹œ JSON íŒŒì¼ ë‚´ìš©ì„ ë³´ê³  ì±„ì›Œì£¼ì„¸ìš”] =================
// JSON íŒŒì¼ : firebase ì ‘ì† -> í”„ë¡œì íŠ¸ ì„¤ì • â†’ "ì„œë¹„ìŠ¤ ê³„ì •" -> "ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„±" â†’ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ

// 1. firebase-adminsdk... ì´ë©”ì¼ 
// Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì„œë¹„ìŠ¤ ê³„ì • â†’ ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„± ì‹œ í™•ì¸ ê°€ëŠ¥
const CLIENT_EMAIL = "your-firebase-adminsdk@your-project.iam.gserviceaccount.com";

// 2. PRIVATE KEY 
// Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì„œë¹„ìŠ¤ ê³„ì • â†’ ìƒˆ ë¹„ê³µê°œ í‚¤ ìƒì„± â†’ JSON íŒŒì¼ì˜ private_key ê°’
// â˜… ì£¼ì˜: \nì„ ì‹¤ì œ ì¤„ë°”ê¿ˆì´ ì•„ë‹Œ ë¬¸ìì—´ \n ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì•¼ í•©ë‹ˆë‹¤
const PRIVATE_KEY = "-----BEGIN PRIVATE KEY-----\nì—¬ê¸°ì—_ì‹¤ì œ_í‚¤_ë‚´ìš©ì„_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”\n-----END PRIVATE KEY-----\n";

// 3. í”„ë¡œì íŠ¸ ID 
// Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì¼ë°˜ íƒ­ â†’ í”„ë¡œì íŠ¸ ID
const PROJECT_ID = "your-firebase-project-id"; 

// 4. Firestore ì»¬ë ‰ì…˜ ì´ë¦„ (ë§¤ìš° ì¤‘ìš” â˜…)
// Firebase ì½˜ì†” -> Firestore Database -> ë°ì´í„° íƒ­ì— ë³´ì´ëŠ” ì²« ë²ˆì§¸ í´ë” ì´ë¦„
// "visitors" ë¼ê³  ë˜ì–´ ìˆì„ ê²ë‹ˆë‹¤. ë‹¤ë¥´ë‹¤ë©´ í™•ì¸ í›„ ë˜‘ê°™ì´ ë§ì¶°ì£¼ì„¸ìš”.
const COLLECTION_NAME = "visitors"; 

// 5. ì‹œíŠ¸ íƒ­ ì´ë¦„ (ë§¤ìš° ì¤‘ìš” â˜…, ì„¤ì •ëœ ì‹œíŠ¸ ì´ë¦„ì´ ì •í™•í•´ì•¼ ë°ì´í„° ë°±ì—… ê°€ëŠ¥)
const SHEET_NAME = "ì‹œíŠ¸1"; 

// 6. ì´ë©”ì¼ ì•Œë¦¼ ë°›ì„ ì£¼ì†Œ (ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•Œë¦¼)
const ALERT_EMAIL = "cjkim@fnj.or.kr"; 

// ===========================================================================
/**
 * 1. ì„¤ì •ê°’ ê²€ì¦ í•¨ìˆ˜
 */
function validateConfig() {
  if (!CLIENT_EMAIL || !PRIVATE_KEY || !PROJECT_ID || !COLLECTION_NAME || !SHEET_NAME) {
    Logger.log("âŒ í•„ìˆ˜ ì„¤ì • ëˆ„ë½:");
    Logger.log(`  - CLIENT_EMAIL: ${CLIENT_EMAIL ? "âœ“" : "âœ—"}`);
    Logger.log(`  - PRIVATE_KEY: ${PRIVATE_KEY ? "âœ“" : "âœ—"}`);
    Logger.log(`  - PROJECT_ID: ${PROJECT_ID ? "âœ“" : "âœ—"}`);
    Logger.log(`  - COLLECTION_NAME: ${COLLECTION_NAME ? "âœ“" : "âœ—"}`);
    Logger.log(`  - SHEET_NAME: ${SHEET_NAME ? "âœ“" : "âœ—"}`);
    return false;
  }
  return true;
}

/**
 * 2. Firestoreì—ì„œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬)
 */
function fetchAllDocuments(token) {
  const allDocs = [];
  let pageToken = null;
  let pageNum = 1;

  while (true) {
    const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${COLLECTION_NAME}?pageSize=300${pageToken ? "&pageToken=" + encodeURIComponent(pageToken) : ""}`;
    
    try {
      const response = UrlFetchApp.fetch(url, {
        method: "get",
        headers: { Authorization: "Bearer " + token },
        muteHttpExceptions: true
      });

      if (response.getResponseCode() !== 200) {
        Logger.log("âŒ Firestore ì ‘ì† ì‹¤íŒ¨ (í˜ì´ì§€ " + pageNum + ")");
        Logger.log("ì‘ë‹µ: " + response.getContentText());
        break;
      }

      const result = JSON.parse(response.getContentText());
      if (result.documents && result.documents.length > 0) {
        allDocs.push(...result.documents);
        Logger.log(`í˜ì´ì§€ ${pageNum}: ${result.documents.length}ê°œ ì¡°íšŒ (ëˆ„ê³„: ${allDocs.length}ê°œ)`);
      }

      // ë‹¤ìŒ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
      if (!result.nextPageToken) {
        break;
      }
      pageToken = result.nextPageToken;
      pageNum++;
    } catch (e) {
      Logger.log(`âŒ í˜ì´ì§€ ${pageNum} ì¡°íšŒ ì‹¤íŒ¨: ${e.message}`);
      break;
    }
  }

  Logger.log(`âœ“ ì´ ${allDocs.length}ê°œ ë¬¸ì„œ ì¡°íšŒ ì™„ë£Œ`);
  return allDocs;
}

/**
 * 3. ì¸ì¦ í† í° ìƒì„±
 */
function getFirebaseService() {
  return OAuth2.createService('Firebase')
    .setTokenUrl('https://oauth2.googleapis.com/token')
    .setPrivateKey(PRIVATE_KEY)
    .setIssuer(CLIENT_EMAIL)
    .setPropertyStore(PropertiesService.getScriptProperties())
    .setScope('https://www.googleapis.com/auth/datastore https://www.googleapis.com/auth/cloud-platform');
}

/**
 * 4. Firestore ë°±ì—… ë° ì‚­ì œ ë©”ì¸ í•¨ìˆ˜ (ê°œì„ ë¨)
 */
function backupAndDelete() {
  const startTime = new Date();
  let errorOccurred = false;
  let errorMessage = "";
  
  try {
    // ì„¤ì •ê°’ ê²€ì¦
    if (!validateConfig()) {
      errorMessage = "ì„¤ì •ê°’ ê²€ì¦ ì‹¤íŒ¨";
      errorOccurred = true;
      return;
    }

    const service = getFirebaseService();
    if (!service.hasAccess()) {
      errorMessage = 'ì¸ì¦ ì‹¤íŒ¨: ' + service.getLastError();
      errorOccurred = true;
      Logger.log('âŒ ' + errorMessage);
      return;
    }
    const token = service.getAccessToken();
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);

    if (!sheet) {
      errorMessage = `ì‹œíŠ¸ ì°¾ê¸° ì‹¤íŒ¨: "${SHEET_NAME}"`;
      errorOccurred = true;
      Logger.log(`âŒ ${errorMessage}`);
      return;
    }

    // (1) Firestore ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ë„¤ì´ì…˜ í¬í•¨)
    Logger.log(`ğŸ“¥ Firestoreì—ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘... (${COLLECTION_NAME})`);
    const allDocuments = fetchAllDocuments(token);

    if (allDocuments.length === 0) {
      Logger.log("â„¹ï¸ ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì‹¤í–‰ ì‹œê°„ ì²´í¬ (4.5ë¶„ ê²½ê³¼ ì‹œ ì¤‘ë‹¨)
    const elapsed = (new Date() - startTime) / 1000;
    if (elapsed > 270) {
      errorMessage = `ì‹¤í–‰ ì‹œê°„ ì´ˆê³¼ (${Math.round(elapsed)}ì´ˆ). ë°ì´í„°ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤.`;
      errorOccurred = true;
      Logger.log(`âš ï¸ ${errorMessage}`);
      return;
    }

    const rowsToAdd = [];
    const docNamesToDelete = [];

    // (2) ë°ì´í„° íŒŒì‹±
    for (let i = 0; i < allDocuments.length; i++) {
      const doc = allDocuments[i];
      const fields = doc.fields;
      
      // ë‚ ì§œ ë° ì‹œê°„ ë³€í™˜ (KST)
      let formattedDate = "";
      if (fields.timestamp && fields.timestamp.timestampValue) {
        const dateObj = new Date(fields.timestamp.timestampValue);
        formattedDate = Utilities.formatDate(dateObj, "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");
      } else {
        formattedDate = Utilities.formatDate(new Date(), "Asia/Seoul", "yyyy-MM-dd HH:mm:ss");
      }

      // í•„ë“œ ê°’ ì¶”ì¶œ
      const gender = fields.gender ? (fields.gender.stringValue || "") : "";
      const ageGroup = fields.ageGroup ? (fields.ageGroup.stringValue || "") : "";
      const source = fields.source ? (fields.source.stringValue || "") : "";
      const location = fields.location ? (fields.location.stringValue || "") : "";
      
      // ì‹œíŠ¸ ì €ì¥ ìˆœì„œ: [ë‚ ì§œì‹œê°„, ì„±ë³„, ì—°ë ¹ëŒ€, ì¶œì²˜, ì¥ì†Œ]
      rowsToAdd.push([formattedDate, gender, ageGroup, source, location]);
      
      // ì‚­ì œë¥¼ ìœ„í•´ì„œëŠ” ê²½ë¡œ í•„ìš”
      docNamesToDelete.push(doc.name);
    }

    // (3) ì‹œíŠ¸ ì €ì¥
    if (rowsToAdd.length > 0) {
      let backupSuccess = false;
      try {
        sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
        Logger.log(`âœ“ ${rowsToAdd.length}ê°œì˜ ë°ì´í„° ë°±ì—… ì™„ë£Œ`);
        backupSuccess = true;
      } catch (e) {
        errorMessage = `ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨: ${e.message}`;
        errorOccurred = true;
        Logger.log(`âŒ ${errorMessage}`);
        Logger.log("âš ï¸ ë°±ì—… ì‹¤íŒ¨ë¡œ ì¸í•´ Firestore ë°ì´í„° ì‚­ì œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤. (ë°ì´í„° ì•ˆì „)");
        return;
      }

      // (4) ë°±ì—… ì„±ê³µ í›„ì—ë§Œ Firestore ë°ì´í„° ì‚­ì œ
      if (backupSuccess) {
        deleteDocuments(token, docNamesToDelete);
      }
    }

    const totalTime = Math.round((new Date() - startTime) / 1000);
    Logger.log(`\nâ±ï¸ ì´ ì‹¤í–‰ ì‹œê°„: ${totalTime}ì´ˆ`);
    
  } catch (error) {
    errorMessage = `ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: ${error.message}`;
    errorOccurred = true;
    Logger.log(`âŒ ${errorMessage}`);
  } finally {
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ë©”ì¼ ì•Œë¦¼
    if (errorOccurred && ALERT_EMAIL && ALERT_EMAIL !== "your-email@example.com") {
      try {
        MailApp.sendEmail({
          to: ALERT_EMAIL,
          subject: "âš ï¸ Firestore ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ ë°œìƒ",
          body: `ì‹¤í–‰ ì‹œê°„: ${startTime}\n\nì˜¤ë¥˜ ë‚´ìš©:\n${errorMessage}\n\nìì„¸í•œ ë¡œê·¸ëŠ” Apps Script ì‹¤í–‰ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`
        });
      } catch (e) {
        Logger.log("ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
      }
    }
  }
}

/**
 * 5. ë¬¸ì„œ ì‚­ì œ í•¨ìˆ˜ (Batch Delete API - ìµœì í™”)
 * - 500ê°œì”© ë¬¶ì–´ì„œ ì²˜ë¦¬ (Firestore Batch ì œí•œ)
 * - ê°œë³„ í˜¸ì¶œ ëŒ€ë¹„ 10ë°° ì´ìƒ ë¹ ë¦„
 * - íƒ€ì„ì•„ì›ƒ ìœ„í—˜ ëŒ€í­ ê°ì†Œ
 */
function deleteDocuments(token, docNames) {
  if (docNames.length === 0) {
    Logger.log("ì‚­ì œí•  ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const batchUrl = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents:batchWrite`;
  let totalDeleted = 0;
  let totalFailed = 0;

  // 500ê°œì”© ë‚˜ëˆ„ê¸° (Firestore Batch ì œí•œ)
  for (let i = 0; i < docNames.length; i += 500) {
    const batch = docNames.slice(i, i + 500);
    
    // Batch Delete ìš”ì²­ êµ¬ì„±
    const writes = batch.map(docName => ({
      delete: docName
    }));

    try {
      const response = UrlFetchApp.fetch(batchUrl, {
        method: "post",
        headers: { 
          Authorization: "Bearer " + token,
          "Content-Type": "application/json"
        },
        payload: JSON.stringify({ writes: writes }),
        muteHttpExceptions: true
      });

      const statusCode = response.getResponseCode();
      
      if (statusCode === 200) {
        totalDeleted += batch.length;
        Logger.log(`âœ“ Batch ${Math.floor(i/500) + 1}: ${batch.length}ê°œ ì‚­ì œ ì„±ê³µ`);
      } else {
        totalFailed += batch.length;
        Logger.log(`âœ— Batch ${Math.floor(i/500) + 1} ì‹¤íŒ¨ (ìƒíƒœ: ${statusCode})`);
        Logger.log(`ì‘ë‹µ: ${response.getContentText()}`);
      }
    } catch (e) {
      totalFailed += batch.length;
      Logger.log(`âš ï¸ Batch ${Math.floor(i/500) + 1} ì˜¤ë¥˜: ${e.message}`);
    }
  }

  Logger.log(`\n=== ì‚­ì œ ì™„ë£Œ ===`);
  Logger.log(`ì´ ${docNames.length}ê°œ ì¤‘ ${totalDeleted}ê°œ ì‚­ì œ ì„±ê³µ`);
  if (totalFailed > 0) {
    Logger.log(`âš ï¸ ${totalFailed}ê°œ ì‚­ì œ ì‹¤íŒ¨ (ì¬ì‹œë„ í•„ìš”)`);
  }
}

/**
 * 6. ì¸ì¦ ë¦¬ì…‹ìš© (í•„ìš” ì‹œë§Œ ì‚¬ìš©)
 */
function resetAuth() {
  getFirebaseService().reset();
  Logger.log("ì¸ì¦ ë¦¬ì…‹ ì™„ë£Œ");
}

/**
 * 7. ì›¹ ì•± API ì—”ë“œí¬ì¸íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬)
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'backup') {
      if (!validateConfig()) {
        return ContentService.createTextOutput(JSON.stringify({ 
          success: false, 
          error: "ì„¤ì •ê°’ ê²€ì¦ ì‹¤íŒ¨" 
        })).setMimeType(ContentService.MimeType.JSON);
      }
      
      // ë°±ì—… ì‘ì—… ì‹¤í–‰ (ì¦‰ì‹œ ì‘ë‹µ ë°˜í™˜)
      // ì›¹ ì•± ì‘ë‹µì€ ë…¼ë¸”ë¡œí‚¹ì´ë¯€ë¡œ í•œ í›„ ì¦‰ì‹œ ë°˜í™˜
      try {
        // backupAndDelete() í•¨ìˆ˜ í˜¸ì¶œ (ë¹„ë™ê¸° ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
        // Apps ScriptëŠ” í•¨ìˆ˜ í˜¸ì¶œì„ ìŠ¤ì¼€ì¤„í•˜ì§€ë§Œ ì‹¤ì œ ì‹¤í–‰ì€ ëŸ°íƒ€ì„ì— ìœ„ì„
        backupAndDelete();
        
        Logger.log('âœ“ ì›¹ ì•±ì„ í†µí•œ ë°±ì—… íŠ¸ë¦¬ê±° ì„±ê³µ - ' + new Date().toISOString());
        
        return ContentService.createTextOutput(JSON.stringify({ 
          success: true, 
          message: "ë°±ì—… ë° ì‚­ì œ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ë¦¬ ì™„ë£Œê¹Œì§€ 1-3ë¶„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
          actionId: Utilities.getUuid(),
          timestamp: new Date().toISOString()
        })).setMimeType(ContentService.MimeType.JSON);
      } catch (backupError) {
        Logger.log('âœ— ë°±ì—… ì‘ì—… ì¤‘ ì˜¤ë¥˜: ' + backupError.message + ' (ìŠ¤íƒ: ' + backupError.stack + ')');
        
        return ContentService.createTextOutput(JSON.stringify({ 
          success: false, 
          error: "ë°±ì—… ì‘ì—… ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: " + backupError.message,
          timestamp: new Date().toISOString()
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    if (action === 'health') {
      // í—¬ìŠ¤ì²´í¬ - ë°°í¬ ìœ íš¨ì„± ë° ì„¤ì • í™•ì¸
      try {
        const config = validateConfig();
        return ContentService.createTextOutput(JSON.stringify({ 
          success: true, 
          message: "ì•± ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•±ì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤",
          configStatus: "ìœ íš¨í•¨",
          timestamp: new Date().toISOString()
        })).setMimeType(ContentService.MimeType.JSON);
      } catch (healthError) {
        return ContentService.createTextOutput(JSON.stringify({ 
          success: false, 
          message: "ì•± ìŠ¤í¬ë¦½íŠ¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨",
          error: healthError.message,
          timestamp: new Date().toISOString()
        })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // ë¯¸ì§€ì› ìš”ì²­
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: "ì§€ì›í•˜ì§€ ì•ŠëŠ” ìš”ì²­ì…ë‹ˆë‹¤. action=backup ë˜ëŠ” action=healthë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.",
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('âœ— doGet ì „ì²´ ì˜¤ë¥˜: ' + error.message + ' (ìŠ¤íƒ: ' + error.stack + ')');
    
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: error.message,
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ğŸ”¥ ìë™í™” ì„¤ì • í•„ìˆ˜ ğŸ”¥
 * 
 * ============================================================
 * 1ë‹¨ê³„: OAuth2 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (í•„ìˆ˜!)
 * ============================================================
 * Apps Script í¸ì§‘ê¸°ì—ì„œ:
 * 1. ì™¼ìª½ "ë¼ì´ë¸ŒëŸ¬ë¦¬ +" í´ë¦­
 * 2. ìŠ¤í¬ë¦½íŠ¸ ID ì…ë ¥: 1B7FSrk5Zi6L1rSxxTDgDEUsPzlukDsi4KGuTMorsTQHhGBzBkMun4iDF
 * 3. "ì¡°íšŒ" í´ë¦­ â†’ "OAuth2" ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„ íƒ
 * 4. ë²„ì „: ìµœì‹  ë²„ì „ ì„ íƒ
 * 5. "ì¶”ê°€" í´ë¦­
 * 
 * ============================================================
 * 2ë‹¨ê³„: íŠ¸ë¦¬ê±° ì„¤ì • (6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰)
 * ============================================================
 * Apps Script í¸ì§‘ í™”ë©´ì—ì„œ:
 * 1. ì™¼ìª½ "íŠ¸ë¦¬ê±°" (ì‹œê³„ ì•„ì´ì½˜) í´ë¦­
 * 2. ì˜¤ë¥¸ìª½ ì•„ë˜ "+ íŠ¸ë¦¬ê±° ì¶”ê°€" í´ë¦­
 * 3. ë‹¤ìŒ ê°’ìœ¼ë¡œ ì„¤ì •:
 *    - ì‹¤í–‰í•  í•¨ìˆ˜: backupAndDelete
 *    - ë°°í¬í•  ì‹¤í–‰: Head
 *    - ì´ë²¤íŠ¸ ì†ŒìŠ¤: ì‹œê°„ ê¸°ë°˜
 *    - ì‹œê°„ ê¸°ë°˜ íŠ¸ë¦¬ê±°: ì‹œê°„ ê°„ê²© íƒ€ì´ë¨¸
 *    - ì‹œê°„ ê°„ê²©: 6ì‹œê°„ë§ˆë‹¤
 *    - ì˜¤ë¥˜ ì•Œë¦¼ ì„¤ì •: ë§¤ì¼
 * 4. "ì €ì¥" í´ë¦­
 * 
 * â€» íŠ¸ë¦¬ê±°ê°€ ìƒì„±ë˜ë©´ (0ì‹œ, 6ì‹œ, 12ì‹œ, 18ì‹œê²½) ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.
 * 
 * ============================================================
 * 3ë‹¨ê³„: ë¬´ë£Œ í‹°ì–´ ì œí•œ í™•ì¸
 * ============================================================
 * 
 * âœ… Firebase Firestore (ë¬´ë£Œ í‹°ì–´)
 *    - ì½ê¸°: 50,000íšŒ/ì¼
 *    - ì“°ê¸°: 20,000íšŒ/ì¼
 *    - ì‚­ì œ: 20,000íšŒ/ì¼
 *    â†’ 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ ì‹œ í•œ ë²ˆì— ìµœëŒ€ 5,000ê°œ ë¬¸ì„œê¹Œì§€ ì•ˆì „
 * 
 * âœ… Google Apps Script (ë¬´ë£Œ í‹°ì–´)
 *    - ì‹¤í–‰ ì œí•œ: 6ë¶„
 *    - ì¼ì¼ íŠ¸ë¦¬ê±°: 90ë¶„ (4ë²ˆ ì‹¤í–‰ = 24ë¶„, ì—¬ìœ  ìˆìŒ)
 *    - ì´ë©”ì¼: 100í†µ/ì¼
 *    â†’ í•œ ë²ˆì— ì•½ 1,500~2,000ê°œ ì²˜ë¦¬ ê°€ëŠ¥ (í‰ê·  3ë¶„ ì´ë‚´)
 * 
 * âœ… Google Sheets (ë¬´ë£Œ í‹°ì–´)
 *    - ì…€ ê°œìˆ˜: 1,000ë§Œ ê°œ (ê±°ì˜ ë¬´ì œí•œ)
 *    - API í˜¸ì¶œ: ë¶„ë‹¹ 60íšŒ (ì¶©ë¶„í•¨)
 * 
 * âš ï¸ ì£¼ì˜ì‚¬í•­:
 * - 6ì‹œê°„ ë™ì•ˆ 1,500ê°œ ì´ìƒ ë°ì´í„°ê°€ ìŒ“ì´ë©´ íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥
 * - ê·¸ëŸ´ ê²½ìš° íŠ¸ë¦¬ê±°ë¥¼ 3ì‹œê°„ë§ˆë‹¤ë¡œ ë³€ê²½ ê¶Œì¥
 * - ì´ë©”ì¼ ì•Œë¦¼ ì„¤ì • í•„ìˆ˜ (ALERT_EMAIL ë³€ìˆ˜ ìˆ˜ì •)
 * 
 * ============================================================
 * 4ë‹¨ê³„: ì´ˆê¸° í…ŒìŠ¤íŠ¸
 * ============================================================
 * 1. Apps Script í¸ì§‘ê¸°ì—ì„œ í•¨ìˆ˜ ì„ íƒ: backupAndDelete
 * 2. "ì‹¤í–‰" ë²„íŠ¼ í´ë¦­
 * 3. ê¶Œí•œ ìŠ¹ì¸ (ìµœì´ˆ 1íšŒ)
 * 4. "ì‹¤í–‰ ë¡œê·¸" í™•ì¸í•˜ì—¬ ì •ìƒ ì‘ë™ í™•ì¸
 * 5. Google Sheetsì—ì„œ ë°ì´í„° ë°±ì—… í™•ì¸
 * 6. Firebaseì—ì„œ ë°ì´í„° ì‚­ì œ í™•ì¸
 * 
 */
