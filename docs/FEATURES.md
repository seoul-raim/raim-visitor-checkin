## 1. 문서 정보

**문서명**: 방문자 체크인 시스템 기능 명세서

**작성일**: 2026-01-28

**수정일**: 2026-02-04

---

## 2. 기능 개요

본 시스템은 5개의 주요 모듈로 구성되며, 각 모듈은 독립적으로 작동하면서 통합되어 완전 자동 방문자 기록 시스템을 제공합니다.

- 전체 시스템 간략 아키텍처
    
    ```mermaid
    graph LR
        A["👤 방문자<br/>(웹 브라우저)"]
        B["📱 React 웹앱<br/>(Vercel)"]
        C["💾 localStorage<br/>(일일 임시)"]
        D["🔥 Firestore<br/>(빠른 저장)"]
        E["⚙️ Apps Script<br/>(자동 백업)"]
        F["📊 Google Sheets<br/>(장기 보관)"]
    
        A -->|카메라/수동 입력| B
        B -->|완료 버튼<br/>임시 저장| C
        B -->|완료 버튼<br/>데이터 전송| D
        C -->|대시보드<br/>통계 조회| C
        D -->|3시간마다<br/>자동 읽기 & 삭제| E
        E -->|백업| F
    
        style A fill:#e3f2fd
        style B fill:#fff3e0
        style C fill:#fff9c4
        style D fill:#f3e5f5
        style E fill:#fce4ec
        style F fill:#e8f5e9
    
    ```
    

---

## 3. 모듈별 상세 기능

### 모듈 1: 웹 사용자 인터페이스 (React)

### 1.1 공통 헤더/네비게이션

- 서비스명 및 로고 표시
- 한/영 지원 토글 버튼

### 1.2 카메라 체크인 화면 (AI 모드)

**목적**: 웹캠을 통한 자동 방문자 인식

**기능**:

- 웹캠 활성화 및 사용 권한 요청
- 얼굴 인식 (face-api.js 활용)
- AI 스캔 버튼 클릭 시 얼굴 감지 수행
- 감지된 성별/연령대를 스캔 확인 모달에 표시
- 스캔 확인 모달:
    - 인식된 방문자 정보 미리보기
    - "확인" 버튼: Firestore에 즉시 전송 (리스트 거치지 않음)
    - "수정" 버튼: 방문자 리스트로 추가하여 수동 편집 가능 (수동 모드로 전환)
    - "닫기" 버튼: 스캔 결과 취소
- 프라이버시 보호: "이미지는 저장되지 않습니다" 배지 표시
- 성공 모달 팝업 (3초 자동 닫기)
- 오류 발생 시 재시도 안내

**입력값**:

- 웹캠 영상 (AI 스캔 버튼 클릭 시 캡처)

**출력값**:

- 성별 (남성/여성)
- 연령대 (유아/어린이/청소년/청년/중년/노년)
- 입력 방식: "AI"
- 위치: 관람실 (관리자 잠금 화면에서 설정)

**예외 처리**:

- 웹캠 미권한: 사용 권한 요청 안내
- 얼굴 감지 실패: "얼굴을 찾을 수 없습니다" 에러 모달
- 네트워크 오류: 재시도 버튼 제공

### 1.3 수동 입력 화면

**목적**: 카메라 오류 또는 특수한 경우의 데이터 수동 입력, AI 스캔 결과 수정

**기능**:

- 입력 양식: 성별, 연령대
- 성별 토글 버튼 (남성/여성)
- 연령대 그리드 버튼 (3x2 레이아웃)
- "추가" 버튼: 방문자 리스트에 추가
- 방문자 리스트로 이동하여 수량 조절 및 삭제 가능
- "모드 전환" 버튼으로 AI 스캔 모드로 복귀 가능

**입력값**:

- 성별: 남성/여성
- 연령대: 유아(0~6세), 어린이(7~12세), 청소년(13~19세), 청년(20~39세), 중년(40~64세), 노년(65세 이상)
- 위치: 관람실 (관리자 잠금 화면에서 설정)

**출력값**:

- 입력 데이터를 방문자 리스트에 추가
- 입력 방식: "Manual" (수동)

### 1.4 관리자 잠금 화면

**목적**: 관리자만 대시보드에 접근 가능하도록 보안 처리

**기능**:

- 관람실 선택 (드롭다운, 기본 목록만 선택 가능)
    - 상설전시
    - 기획전시
    - 사일런트 도슨트
    - 전시연계
    - 다목적실-1, 2, 3
- 비밀번호 입력 (PIN)
- 관람실 저장 (localStorage)
- 오류 시 "비밀번호 오류" 메시지

**입력값**:

- 관람실: 기본 목록에서 선택 (커스텀 입력 불가)
- 비밀번호: ADMIN_PIN 환경변수

**출력값**:

- 인증 성공 시: 메인 화면과 관리자 대시보드 진입 가능

**보안**:

- HTTPS 전송
- 클라이언트 사이드 검증
- 비밀번호는 로컬스토리지에 저장 안 함

**제약 사항**:

- 커스텀 관람실 입력은 대시보드에서만 가능

### 1.5 방문자 리스트

**목적**: 전송 전 방문자 데이터 확인 및 편집

**기능**:

- 등록된 방문자 목록 표시
- 방문자 그룹화:
    - 동일한 성별/연령대/입력방식은 하나의 항목으로 그룹화
    - 수량 표시 (예: 청년 남성 x3)
- 수량 조절:
    - "+" 버튼: 동일 조건 방문자 추가 (새 ID 생성)
    - "-" 버튼: 수량 감소 (마지막 항목 삭제)
    - 수량이 0이 되면 그룹 자동 제거
    - "X" 버튼: 해당 그룹 전체 삭제
- "초기화" 버튼: 전체 목록 비우기
- 총 인원수 배지 표시
- 빈 상태: "등록된 관람객이 없습니다" 메시지

**데이터 흐름**:

1. AI 스캔의 "수정" 선택 또는 수동 입력으로 방문자 추가
2. 리스트에서 확인 및 편집
3. "완료" 버튼으로 Firestore 전송

**특징**:

- useMemo로 그룹화 성능 최적화
- 동일한 성별/연령대/입력방식은 자동 그룹화
- 각 그룹별 수량 표시 및 증감 버튼 제공
- localStorage에 전송 후에도 데이터 유지 (일일 통계용)
- Firestore 전송 성공 시 리스트만 초기화 (localStorage 데이터는 유지)
- 과거 날짜 데이터는 앱 시작 시 자동 삭제

---

### 1.6 관리자 대시보드

**목적**: 관리자가 일일 통계와 설정을 관리

**접근 방법**: 로고를 3회 연속 터치 (3초 내)

**기능**:

- **일일 통계 표시** (localStorage 기반, 관람실별 필터링)
    - 오늘의 누적 입장객 수 (현재 관람실)
    - 연령대별 분포 (막대 차트)
    - 성별 분포 (도넛 차트 + 비율 표시)
    - 자정마다 자동 초기화
- **설정 관리**
    - 관람실 선택 (드롭다운)
        - 기본 관람실 목록에서 선택
        - "직접 입력 (커스텀)" 옵션 선택 시 커스텀 관람실 이름 입력 가능
        - 커스텀 관람실 입력 필드: 텍스트 입력, Edit3 아이콘 표시
        - 입력된 커스텀 관람실 이름은 데이터 전송에 사용됨
    - 나이 보정값 조정 (-10 ~ +10, 슬라이더)
    - 설정 저장 (localStorage)
- **데이터 백업 및 삭제** (새로운 기능)
    - 별도 섹션 (빨간 테마로 위험도 표시)
    - "지금 백업 및 삭제 실행" 버튼
    - 기능:
      - Firebase Firestore의 모든 방문객 데이터를 Google Sheets로 자동 백업
      - 백업 완료 후 Firestore 데이터 자동 삭제
      - 2단계 확인 모달로 실수 방지
    - 상태 피드백:
      - 로딩 중: 스피너 아이콘 표시
      - 성공: 녹색 메시지 표시
      - 오류: 빨간색 에러 메시지 표시
    - 접근: Google Apps Script doGet() 함수와 연동
- **데이터 소스 안내**
    - "기기 임시 저장 데이터입니다"
    - "정확한 전체 데이터는 Firebase 또는 엑셀을 확인하세요"

**데이터 소스**: localStorage만 사용 (Firestore 조회 없음)

- `todayVisitors_[날짜]` 키에서 오늘 날짜의 방문객 데이터 조회
- 선택한 관람실의 방문객만 필터링하여 통계 표시 (기본 관람실 및 커스텀 관람실 모두 지원)
- 저장된 커스텀 관람실이 있으면 자동으로 로드하여 표시

**갱신 주기**: 앱 시작 시 과거 날짜 데이터 자동 삭제

- localStorage의 모든 `visitorCount_*`, `todayVisitors_*` 키 검사
- 오늘 날짜가 아닌 데이터는 자동 제거

**접근 제어**: 별도 인증 없음 (로고 터치만)

---

### 모듈 2: 얼굴 인식 엔진 (face-api.js)

### 2.1 모델 로드

**목적**: 얼굴 인식 AI 모델 초기화

**기능**:

- 모델 파일 다운로드 (public/models/ 폴더)
- 성별 감지 모델 로드
- 연령대 분류 모델 로드
- 얼굴 감지 모델 로드 (MTCNN)

**성능**: 초기화 시간 2~3초

### 2.2 연속 얼굴 감지

**목적**: 비디오 스트림에서 얼굴 찾기

**기능**:

- requestAnimationFrame으로 30fps 감지
- 얼굴 위치 박스 표시
- 신뢰도 필터링 (50% 이상)
- 감지 실패 시 "얼굴이 없습니다" 표시

### 2.3 성별 및 연령대 예측

**목적**: 감지된 얼굴에서 성별/나이 추출

**기능**:

- 성별 분류: 남성/여성 (확률 기반)
- 연령대 변환 (한국식 분류 + 나이 보정값 적용):
    - AI 인식 나이 + 보정값(기본 +4세)
    - 0~6세: 유아
    - 7~12세: 어린이
    - 13~19세: 청소년
    - 20~39세: 청년
    - 40~64세: 중년
    - 65세 이상: 노년
- 나이 보정값: -10 ~ +10 범위에서 관리자 대시보드에서 조정 가능

**정확도**: 약 80~85% (성별), 약 70~75% (연령대)
**한국 나이 보정**: 기본 +4세 보정으로 한국 나이 기준 정확도 향상

---

### 모듈 3: 데이터 저장소 (Firebase Firestore)

### 3.1 Collection 구조

```
visitors/
├── document ID: timestamp (자동 생성)
├── timestamp: "2026-01-28T14:30:45Z"
├── gender: "남성" | "여성"
├── ageGroup: "10대" | "20대" | ... | "60대+"
├── source: "AI" | "수동"
├── location: "상설전시" | "다목적실-1" | ...

```

### 3.2 데이터 쓰기

**목적**: 체크인 데이터 저장

**트리거**: 사용자가 "체크인" 버튼 클릭

**처리**:

```jsx
{
  timestamp: new Date().toISOString(),
  gender: detectedGender,
  ageGroup: convertedAgeGroup,
  source: "AI" || "수동",
  location: selectedLocation
}

```

**응답 시간**: 1초 이내

**오류 처리**: 네트워크 오류 시 재시도 버튼 제공 (ErrorModal)

### 3.3 권한 관리

**Firestore Security Rules**:

```
- 읽기: 인증된 사용자만
- 쓰기: 인증된 사용자만
- 삭제: Apps Script 서비스 계정만

```

---

### 모듈 4: 자동화 엔진 (Google Apps Script)

### 4.1 자동 백업 함수 (backupAndDelete)

**목적**: Firestore 데이터를 Google Sheets에 정기적으로 백업

**실행 조건**:

- 트리거: 사용자 설정 간격 (1/3/6/12시간)
- 실행 시간 제한: 6분 이내
- 타임아웃 시: 작업 중단 후 오류 알림 (로그/이메일)

**처리 흐름**:

1. **데이터 조회** (fetchAllDocuments)
    - Firestore에서 모든 문서 조회
    - pageSize: 300 (페이지네이션)
    - 페이지네이션: 자동으로 모든 페이지 조회
    - 경고: 실행 시간 체크 (4.5분 초과 시 중단)
2. **데이터 검증**
    - 빈 데이터셋 확인
    - 필수 필드 검증 (timestamp, gender, ageGroup 등)
3. **Google Sheets에 추가**
    - 배열로 한 번에 처리 (setValues API)
    - KST 시간대로 날짜 포맷팅
    - 컬럼 순서: [날짜시간, 성별, 연령대, 방법, 장소]
4. **안전한 삭제**
    - 백업 성공 확인 후에만 삭제 진행
    - Batch Delete API 사용 (500개/배치)
    - 개별 삭제 대비 10배 이상 빠름
5. **로깅 및 알림**
    - 성공: "✓ 총 X개 문서 조회 및 백업 완료"
    - 오류: 이메일 알림 (ALERT_EMAIL로)

### 4.2 Apps Script 설치 및 설정

**파일 위치**: `./public/script.txt`

**1단계: OAuth2 라이브러리 추가 (필수)**

```
Apps Script 편집기:
1. 왼쪽 "라이브러리 +" 클릭
2. 스크립트 ID: 1B7FSrk5Zi6L1rSxxTDgDEUsPzlukDsi4KGuTMorsTQHhGBzBkMun4iDF
3. "조회" → "OAuth2" 선택 → 최신 버전 → "추가"

```

**2단계: 설정값 입력**

```jsx
// Firebase 서비스 계정 정보 (Firebase 콘솔에서 생성)
const CLIENT_EMAIL = "your-firebase-adminsdk@....iam.gserviceaccount.com";
const PRIVATE_KEY = "-----BEGIN PRIVATE KEY-----\\\\n...\\\\n-----END PRIVATE KEY-----\\\\n";
const PROJECT_ID = "your-firebase-project-id";

// Firestore 및 Sheets 설정
const COLLECTION_NAME = "visitors";  // Firestore 컬렉션명
const SHEET_NAME = "시트1";          // Google Sheets 탭 이름

// 알림 이메일
const ALERT_EMAIL = "your-email@example.com";

```

**3단계: 트리거 설정**

```
Apps Script 편집기:
1. 왼쪽 "트리거" (시계 아이콘) 클릭
2. "+ 트리거 추가"
3. 설정:
   - 실행할 함수: backupAndDelete
   - 이벤트 소스: 시간 기반
   - 시간 간격: 6시간마다 (또는 3시간마다)
   - 오류 알림: 매일
4. "저장"

```

**4단계: 초기 테스트**

```
1. 함수 선택: backupAndDelete
2. "실행" 버튼 클릭
3. 권한 승인 (최초 1회)
4. "실행 로그" 확인
5. Google Sheets 및 Firestore에서 결과 확인

```

### 4.3 설정 검증 함수 (validateConfig)

**목적**: 필수 설정값 확인

**검증 항목**:

- CLIENT_EMAIL: Firebase 서비스 계정 이메일
- PRIVATE_KEY: Firebase 비공개 키
- PROJECT_ID: Firebase 프로젝트 ID
- COLLECTION_NAME: Firestore 컬렉션명
- SHEET_NAME: Google Sheets 탭 이름
- ALERT_EMAIL: 알림 이메일

**동작**:

- 누락 항목 발견 시: 명확한 오류 메시지 출력
- 모두 설정 시: "✓ 설정 검증 완료"

### 4.3 Firebase 인증 함수 (getFirebaseService)

**목적**: OAuth2로 Firebase API 접근

**동작**:

- OAuth2 라이브러리 활용
- 서비스 계정 키로 토큰 생성
- 토큰 유효성: 1시간
- 토큰 캐싱: 자동 갱신

**스코프**:

- `https://www.googleapis.com/auth/datastore`
- `https://www.googleapis.com/auth/cloud-platform`

### 4.4 삭제 함수 (deleteDocuments)

**목적**: Firestore에서 안전하게 데이터 제거

**특징**:

- Batch Delete API 활용 (개별 삭제 대비 10배 이상 빠름)
- 최대 500개/배치 (Firestore 제한)
- 여러 배치로 자동 분할 처리
- 각 배치마다 로그: "Batch N: X개 삭제 성공"
- 실패 시 재시도 로그 표시

**성능**: 1,500개 문서 삭제 시 약 30초 소요

### 4.5 트리거 설정

**타입**: 시간 기반 타이머

**옵션**:

- 1시간마다: 1,500~3,000명/일 예상
- 3시간마다: 1,000~1,500명/일 권장 (주말 폭증 시)
- 6시간마다: 500~1,000명/일 기본
- 12시간마다: 200~500명/일 최소

**설정 위치**: Apps Script 대시보드 → 트리거 메뉴

---

### 모듈 5: 영구 저장소 (Google Sheets)

### 5.1 시트 구조

**시트명**: 시트1 (기본값, 설정 가능)

**컬럼 헤더** (자동 생성):

| A | B | C | D | E |
| --- | --- | --- | --- | --- |
| 날짜시간 | 성별 | 연령대 | 방법 | 장소 |

**데이터 행**:

```
2026-01-28 14:30:45 | 남성 | 30대 | AI | 다목적실-1
2026-01-28 14:35:12 | 여성 | 20대 | 수동 | 상설전시

```

### 5.2 데이터 추가

**동작**:

- 설정된 시각마다 새 행 추가
- 행 추가 방식: setValues() API (배열로 한 번에 처리)
- KST 시간대로 자동 포맷팅
- 컬럼 순서: [날짜시간, 성별, 연령대, 방법, 장소]

**성능**:

- 100행: <1초
- 300행: <2초
- 1,500행: <5초

### 5.3 통계 활용

**지원 함수**:

- COUNTA: 방문자 총 수
- COUNTIF: 성별/연령대별 집계
- AVERAGE: 평균 계산

**활용 사례**:

```
=COUNTIF(B:B, "남성") → 남성 방문자 수
=COUNTIF(C:C, "20대") → 20대 방문자 수

```

### 5.4 용량 관리

**저장량**: 1,000만 셀
**예상 사용량**: 연간 365만 셀 (36% 사용)
**유지보수**:

- 연 1회: 이전 연도 데이터 별도 파일로 이동
- 또는: 월별 시트 분할

---

## 4. 데이터 흐름

### 4.1 정상 체크인 흐름

```
1. 사용자 웹사이트 접속
   ↓
2. AI 스캔 또는 수동 입력
   ↓
3. React → Firestore 데이터 저장
   ↓
4. 대시보드 실시간 갱신
   ↓
5. 3시간 후 (또는 설정 시간)
   ↓
6. Google Apps Script 자동 실행
   ↓
7. Firestore 데이터 읽기
   ↓
8. Google Sheets 백업
   ↓
9. Firestore 데이터 삭제
   ↓
10. 완료 로그 기록

```

### 4.2 오류 발생 시 흐름

```
1. 이메일 알림 발송
   (ALERT_EMAIL로)
   ↓
2. 로그 기록
   (Apps Script 실행 로그)
   ↓
3. 다음 실행 대기
   (수동 확인 후 재시도)

```

---

## 5. 예외 및 오류 처리

### 5.1 웹 인터페이스 오류

| 오류 | 원인 | 해결책 |
| --- | --- | --- |
| 웹캠 미권한 | 사용자가 권한 거부 | 권한 요청 재시도 |
| 얼굴 미감지 | 조명 부족/각도 문제 | 오류 메시지 확인 및 재시도 |
| 네트워크 오류 | WiFi 단절 | 오류 메시지 확인 및 재시도 |
| Firestore 접속 실패 | 인증 오류 | 오류 메시지 확인 및 재시도 |

### 5.2 Apps Script 오류

| 오류 | 원인 | 해결책 |
| --- | --- | --- |
| OAuth2 미정의 | 라이브러리 미추가 | 라이브러리 추가 필수 |
| 403 Forbidden | 서비스 계정 키 오류 | Firebase JSON 재생성 |
| 시트 찾기 실패 | SHEET_NAME 오타 | 정확한 탭 이름 확인 |
| 타임아웃 (6분) | 데이터 과다 | 트리거 간격 단축 |

### 5.3 복구 전략

- **자동 복구**: 없음 (타임아웃 시 오류 알림 후 수동 재시도)
- **수동 복구**: Apps Script 수동 재실행
- **데이터 안전**: 백업 전 삭제 하지 않음