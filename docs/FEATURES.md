## 1. 문서 정보

**문서명**: 방문자 체크인 시스템 기능 명세서

**작성일**: 2026-01-28

**대상**: 개발자, 테스터, 운영자

**관련 문서**: [요구사항 명세서](https://www.notion.so/SRS-2f51b986cb978005a52edb12229ad618?pvs=21) | [시스템 아키텍처](https://www.notion.so/2f61b986cb9780b9b26bc5251fa6a5ac?pvs=21) | [유지보수 가이드](https://www.notion.so/2f61b986cb9780c5a898fe360c73d1cf?pvs=21)| [설치 및 배포 가이드](https://www.notion.so/2f61b986cb9780d1ac08f65d2acb7a61?pvs=21)|

---

## 2. 기능 개요

본 시스템은 5개의 주요 모듈로 구성되며, 각 모듈은 독립적으로 작동하면서 통합되어 완전 자동 방문자 관리 시스템을 제공합니다.

![diagram (3).jpg](attachment:29ba4ed4-7df9-4b5f-8747-6c2274196fdf:diagram_(3).jpg)

---

## 3. 모듈별 상세 기능

### 모듈 1: 웹 사용자 인터페이스 (React)

### 1.1 공통 헤더/네비게이션

- 서비스명 및 로고 표시
- 현재 시간 실시간 표시
- 관리자 로그인/로그아웃 버튼

### 1.2 카메라 체크인 화면

**목적**: 웹캠을 통한 자동 방문자 인식

**기능**:

- 웹캠 활성화 및 사용 권한 요청
- 얼굴 인식 (face-api.js 활용)
- 감지된 성별/연령대 표시
- 체크인 버튼 클릭 시 데이터 저장
- 성공 모달 팝업 (3초 자동 닫기)
- 오류 발생 시 재시도 안내

**입력값**:

- 웹캠 영상 (자동 캡처)
- 위치/출입구 선택 (드롭다운)

**출력값**:

- 성별 (남성/여성)
- 연령대 (10대, 20대, ..., 60대+)
- 입력 방식: "카메라"

**예외 처리**:

- 웹캠 미권한: 사용 권한 요청 안내
- 얼굴 감지 실패: "얼굴이 인식되지 않습니다" 메시지
- 네트워크 오류: 재시도 버튼 제공

### 1.3 수동 입력 화면

**목적**: 카메라 오류 또는 특수한 경우의 데이터 입력

**기능**:

- 입력 양식: 성별(라디오), 연령대(드롭다운), 위치(드롭다운)
- 필수값 검증
- 제출 버튼 클릭 시 데이터 저장
- 성공 모달 팝업 (3초 자동 닫기)
- 초기화 버튼으로 폼 리셋

**입력값**:

- 성별: 남성/여성
- 연령대: 10대, 20대, 30대, 40대, 50대, 60대+
- 위치: 1층/2층/.../회의실 (설정 가능)

**출력값**:

- 입력 데이터 저장
- 입력 방식: "수동"

### 1.4 관리자 잠금 화면

**목적**: 관리자만 대시보드에 접근 가능하도록 보안 처리

**기능**:

- 관람실 선택 (드롭다운)
    - 상설전시
    - 기획전시
    - 사일런트 도슨트
    - 전시연계
    - 다목적실-1, 2, 3
- 비밀번호 입력 (PIN)
- 관람실 저장 (localStorage)
- 오류 시 "비밀번호 오류" 메시지

**입력값**:

- 관람실: 7개 중 선택
- 비밀번호: ADMIN_PIN 환경변수

**출력값**:

- 인증 성공 시: 관리자 대시보드 진입

**보안**:

- HTTPS 전송
- 클라이언트 사이드 검증
- 비밀번호는 로컬스토리지에 저장 안 함

### 1.5 관리자 대시보드

**목적**: 관리자가 일일 통계와 설정을 관리

**기능**:

- 일일 통계 표시 (localStorage 기반)
    - 총 방문자 수
    - 성별 비율 (파이 차트)
    - 연령대별 분포 (막대 차트)
    - 입력 방식별 통계 (카메라 vs 수동)
    - 위치별 방문자 수 (테이블)
- 설정 관리
    - 스캔 확인 타임아웃 조정 (5~30초)
    - 수동 입력 시간 조정
    - 데이터 다운로드
- 방문자 목록 조회
- 기간별 필터링

**데이터 소스**: localStorage (일일 통계), Firestore (방문자 목록)

**갱신 주기**: localStorage는 자정 초기화

**접근 제어**: 관리자 잠금 화면 통과 필수

---

### 모듈 2: 얼굴 인식 엔진 (face-api.js)

### 2.1 모델 로드

**목적**: 얼굴 인식 AI 모델 초기화

**기능**:

- 모델 파일 다운로드 (public/models/ 폴더)
- 성별 감지 모델 로드
- 연령대 분류 모델 로드
- 얼굴 감지 모델 로드 (MTCNN)

**성능**: 초기화 시간 2~3초

### 2.2 연속 얼굴 감지

**목적**: 비디오 스트림에서 얼굴 찾기

**기능**:

- requestAnimationFrame으로 30fps 감지
- 얼굴 위치 박스 표시
- 신뢰도 필터링 (50% 이상)
- 감지 실패 시 "얼굴이 없습니다" 표시

### 2.3 성별 및 연령대 예측

**목적**: 감지된 얼굴에서 성별/나이 추출

**기능**:

- 성별 분류: 남성/여성 (확률 기반)
- 연령대 변환:
    - 0~13: 10대
    - 14~19: 10대
    - 20~29: 20대
    - 30~39: 30대
    - 40~49: 40대
    - 50~59: 50대
    - 60+: 60대+

**정확도**: 약 80~85% (성별), 약 70~75% (연령대)

---

### 모듈 3: 데이터 저장소 (Firebase Firestore)

### 3.1 Collection 구조

```
visitors/
├── document ID: timestamp (자동 생성)
├── timestamp: "2026-01-28T14:30:45Z"
├── gender: "남성" | "여성"
├── ageGroup: "10대" | "20대" | ... | "60대+"
├── source: "카메라" | "수동"
├── location: "1층" | "2층" | ...

```

### 3.2 데이터 쓰기

**목적**: 체크인 데이터 저장

**트리거**: 사용자가 "체크인" 버튼 클릭

**처리**:

```jsx
{
  timestamp: new Date().toISOString(),
  gender: detectedGender,
  ageGroup: convertedAgeGroup,
  source: "카메라" || "수동",
  location: selectedLocation
}

```

**응답 시간**: 1초 이내

**오류 처리**: 네트워크 오류 시 3회 재시도

### 3.3 데이터 읽기 (대시보드용)

**목적**: 실시간 통계 계산

**쿼리**:

- 오늘 날짜의 모든 문서 조회
- where timestamp >= today 00:00:00

**빈도**: 10초마다 갱신

**성능**: 100개 문서 기준 <100ms

### 3.4 권한 관리

**Firestore Security Rules**:

```
- 읽기: 인증된 사용자만
- 쓰기: 인증된 사용자만
- 삭제: Apps Script 서비스 계정만

```

---

### 모듈 4: 자동화 엔진 (Google Apps Script)

### 4.1 자동 백업 함수 (backupAndDelete)

**목적**: Firestore 데이터를 Google Sheets에 정기적으로 백업

**실행 조건**:

- 트리거: 사용자 설정 간격 (1/3/6/12시간)
- 실행 시간 제한: 6분 이내
- 타임아웃 시: 부분 백업 모드 전환

**처리 흐름**:

1. **데이터 조회** (fetchAllDocuments)
    - Firestore에서 모든 문서 조회
    - pageSize: 500 (API 효율 40% 개선)
    - 페이지네이션: 10페이지 최대 (5,000 문서)
    - 경고: 1,000개 이상 시 로그 기록
    - 경고: 2,000개 이상 시 경고 로그
2. **데이터 검증**
    - 빈 데이터셋 확인
    - 필수 필드 검증 (timestamp, gender, ageGroup 등)
3. **Google Sheets에 추가**
    - CHUNK_SIZE: 5,000행씩 처리
    - 각 청크마다 timeout 체크
    - 272초 이상 경과 시: 타임아웃 모드 전환
    - 로그: "부분 백업 완료, X개 행 저장됨"
4. **안전한 삭제**
    - 백업된 문서만 삭제 추적
    - 삭제 전: 백업 데이터 row 수 확인
    - Batch Delete API 사용 (500개/배치)
    - 삭제 확인: Firestore 재조회
5. **로깅 및 알림**
    - 성공: "✓ 총 X개 문서 조회 및 백업 완료"
    - 경고: "⚠️ 주의: 1,000개 이상 문서 감지"
    - 오류: 이메일 알림 (ALERT_EMAIL로)

### 4.2 설정 검증 함수 (validateConfig)

**목적**: 필수 설정값 확인

**검증 항목**:

- CLIENT_EMAIL: Firebase 서비스 계정 이메일
- PRIVATE_KEY: Firebase 비공개 키
- PROJECT_ID: Firebase 프로젝트 ID
- COLLECTION_NAME: Firestore 컬렉션명
- SHEET_NAME: Google Sheets 탭 이름
- ALERT_EMAIL: 알림 이메일

**동작**:

- 누락 항목 발견 시: 명확한 오류 메시지 출력
- 모두 설정 시: "✓ 설정 검증 완료"

### 4.3 Firebase 인증 함수 (getFirebaseService)

**목적**: OAuth2로 Firebase API 접근

**동작**:

- OAuth2 라이브러리 활용
- 서비스 계정 키로 토큰 생성
- 토큰 유효성: 1시간
- 토큰 캐싱: 자동 갱신

### 4.4 삭제 함수 (deleteDocuments)

**목적**: Firestore에서 안전하게 데이터 제거

**특징**:

- Batch Delete API 활용
- 최대 500개/배치
- 10개 배치 제한 (5,000 문서 최대)
- 각 배치마다 로그: "배치 N: X개 삭제"

**성능**: 개별 삭제 대비 10배 빠름

### 4.5 트리거 설정

**타입**: 시간 기반 타이머

**옵션**:

- 1시간마다: 1,500~3,000명/일 예상
- 3시간마다: 1,000~1,500명/일 권장 (주말 폭증 시)
- 6시간마다: 500~1,000명/일 기본
- 12시간마다: 200~500명/일 최소

**설정 위치**: Apps Script 대시보드 → 트리거 메뉴

---

### 모듈 5: 영구 저장소 (Google Sheets)

### 5.1 시트 구조

**시트명**: 시트1 (기본값, 설정 가능)

**컬럼 헤더** (자동 생성):

| A | B | C | D | E |
| --- | --- | --- | --- | --- |
| 날짜시간 | 성별 | 연령대 | 출처 | 장소 |

**데이터 행**:

```
2026-01-28 14:30:45 | 남성 | 30대 | 카메라 | 1층
2026-01-28 14:35:12 | 여성 | 20대 | 수동 | 1층
...

```

### 5.2 데이터 추가

**동작**:

- 설정된 시각마다 새 행 추가
- 행 추가 방식: setValues() API
- 배치 처리: 5,000행씩
- 헤더 자동 생성 (첫 행이 비어있으면)

**성능**:

- 100행: <500ms
- 5,000행: <2초

### 5.3 통계 활용

**지원 함수**:

- COUNTA: 방문자 총 수
- COUNTIF: 성별/연령대별 집계
- AVERAGE: 평균 계산

**활용 사례**:

```
=COUNTIF(B:B, "남성") → 남성 방문자 수
=COUNTIF(C:C, "20대") → 20대 방문자 수

```

### 5.4 용량 관리

**저장량**: 1,000만 셀
**예상 사용량**: 연간 365만 셀 (36% 사용)
**유지보수**:

- 연 1회: 이전 연도 데이터 별도 파일로 이동
- 또는: 월별 시트 분할

---

## 4. 데이터 흐름

### 4.1 정상 체크인 흐름

```
1. 사용자 웹사이트 접속
   ↓
2. 카메라 또는 수동 입력
   ↓
3. React → Firestore 데이터 저장
   ↓
4. 대시보드 실시간 갱신
   ↓
5. 3시간 후 (또는 설정 시간)
   ↓
6. Google Apps Script 자동 실행
   ↓
7. Firestore 데이터 읽기
   ↓
8. Google Sheets 백업
   ↓
9. Firestore 데이터 삭제
   ↓
10. 완료 로그 기록

```

### 4.2 오류 발생 시 흐름

```
1. 이메일 알림 발송
   (ALERT_EMAIL로)
   ↓
2. 로그 기록
   (Apps Script 실행 로그)
   ↓
3. Firestore 데이터 보존
   (삭제 안 함)
   ↓
4. 다음 실행 대기
   (수동 확인 후 재시도)

```

---

## 5. 예외 및 오류 처리

### 5.1 웹 인터페이스 오류

| 오류 | 원인 | 해결책 |
| --- | --- | --- |
| 웹캠 미권한 | 사용자가 권한 거부 | 권한 요청 재시도 |
| 얼굴 미감지 | 조명 부족/각도 문제 | "얼굴을 다시 맞춰주세요" 메시지 |
| 네트워크 오류 | WiFi 단절 | 3회 자동 재시도 |
| Firestore 접속 실패 | 인증 오류 | 개발자 콘솔 확인 필수 |

### 5.2 Apps Script 오류

| 오류 | 원인 | 해결책 |
| --- | --- | --- |
| OAuth2 미정의 | 라이브러리 미추가 | 라이브러리 추가 필수 |
| 403 Forbidden | 서비스 계정 키 오류 | Firebase JSON 재생성 |
| 시트 찾기 실패 | SHEET_NAME 오타 | 정확한 탭 이름 확인 |
| 타임아웃 (6분) | 데이터 과다 | 트리거 간격 단축 |

### 5.3 복구 전략

- **자동 복구**: 부분 백업 모드 (타임아웃 시)
- **수동 복구**: Apps Script 수동 재실행
- **데이터 안전**: 백업 전 삭제 하지 않음

---

## 6. 성능 지표

### 6.1 응답 시간

| 작업 | 목표 | 실제 |
| --- | --- | --- |
| 페이지 로딩 | 2초 | <1.5초 |
| 얼굴 감지 | 1초 | <1초 |
| 데이터 저장 | 1초 | <0.5초 |
| 대시보드 갱신 | 10초 | 10초 |
| 백업 (1,000개) | 5분 | 4분 |

### 6.2 처리량

| 시나리오 | 처리량 | 무료 한도 |
| --- | --- | --- |
| 평소 (500명/일) | OK | 사용률 <20% |
| 중간 (1,000명/일) | OK | 사용률 <40% |
| 폭증 (1,500명/일) | OK | 사용률 40~60% |
| 매우 많음 (3,000명/일) | OK | 사용률 ~80% |

---

## 7. 보안 고려사항

### 7.1 인증

- 웹 앱: 없음 (공개 접근)
- 관리자 화면: 암호 보호
- Apps Script: 서비스 계정 인증
- Firestore: 서비스 계정 + 공개 읽기

### 7.2 데이터 보호

- 전송: HTTPS 암호화
- 저장: Firebase 자동 암호화
- 개인정보: 집계 후 자동 삭제
- 백업: Google Sheets 자동 암호화

### 7.3 접근 제어

- Firebase Security Rules:
    - 읽기: 인증된 사용자
    - 쓰기: 인증된 사용자
    - 삭제: Apps Script만

---

## 8. 확장성 및 유지보수

### 8.1 향후 기능

- 데이터 필터링 및 검색
- 고급 통계 (히트맵, 시계열)
- 문자/카톡 알림
- 멀티 출입구 지원
- 얼굴 인식 정확도 개선

### 8.2 성능 개선

- 인덱싱 추가 (대량 조회 시)
- 캐싱 구현 (반복 쿼리)
- CDN 활용 (모델 파일 배포)

### 8.3 운영 자동화

- 모니터링 대시보드 (Data Studio)
- 자동 모니터링 알림
- 일일 리포트 이메일

---

## 9. 테스트 항목

### 9.1 기능 테스트

- [ ]  카메라 체크인 (5회)
- [ ]  수동 입력 (5회)
- [ ]  대시보드 실시간 갱신
- [ ]  관리자 화면 접근
- [ ]  Google Apps Script 자동 실행
- [ ]  Firestore 데이터 삭제

### 9.2 성능 테스트

- [ ]  1,000명 일일 트래픽 시뮬레이션
- [ ]  응답 시간 <2초 확인
- [ ]  무료 한도 사용률 모니터링
- [ ]  타임아웃 복구 검증

### 9.3 보안 테스트

- [ ]  암호 없이 관리자 화면 접근 불가 확인
- [ ]  Firebase 규칙 검증
- [ ]  서비스 계정 키 로테이션

---